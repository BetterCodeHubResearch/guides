<!DOCTYPE html>
<html lang="en-us">
  <head>
    <title>Gems with Extensions - RubyGems Guides</title>
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <meta charset="utf-8" />
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta http-equiv="Description" name="Description" content="Tutorials, guides, FAQs for RubyGems package management" />
    <meta http-equiv="Keywords" name="Keywords" content="rubygems, gems, programming, ruby, packages" />
    <script src="//use.typekit.net/lkc4mmu.js" type="text/javascript"></script>
    <script>
      try{Typekit.load();}catch(e){}
    </script>
    <script src="//code.jquery.com/jquery-2.1.1.min.js"></script>
    <script>
      $(function() {
        var path = window.location.pathname;
        $('a[href="'+path.substring(0, path.length -1)+'"]').addClass('is-active');
      });
    </script>
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" name="viewport">
    <link href="/stylesheets/application.css" rel="stylesheet" type="text/css" />
    <!--[if !IE]>-->
      <meta name="viewport" content="width=device-width">
      <script type="text/javascript">
        window.scrollTo(0, 1);
      </script>
    <!--<![endif]-->
  </head>

  <body class="default">
    <header class="header header--interior">
      <div class="l-wrap--header">
        <a class="header__logo-wrap" href="/">
          <span class="header__logo" data-icon="⬡">⬢</span>
          <span class="t-hidden">RubyGems</span>
        </a>
        <a class="header__club-sandwich" href="#">
          <span class="t-hidden">Navigation menu</span>
        </a>

        <div class="header__nav-links-wrap">
          <form class="header__search-wrap">
            <input class="header__search" id="header__search" name="header__search" placeholder="Search Gems..." type="search">
            <label class="header__search__icon" data-icon="⌕" for="header__search">
              <span class="t-hidden">Search gems</span>
            </label>
          </form>

          <nav class="header__nav-links">
            <a class="header__nav-link" href="/gems">Gems</a>
            <a class="header__nav-link" href="/guides">Guides</a>
            <a class="header__nav-link" href="/contribute">Contribute</a>
            <a class="header__nav-link" href="#" id="js-sign-in-trigger">Sign In</a>
            <a class="header__nav-link js-sign-up-trigger" href="#">Sign Up</a>
          </nav>
        </div>
      </div>
    </header>

    <main class="main--interior">
      <div class="l-wrap--b">
        <a class="t-display page__heading" href="/">Guides</a>
        <div class="l-overflow">
          <div class="l-col--l">
            <div class="nav--v">
              <a class="nav--v__link" href="/rubygems-basics">RubyGems Basics</a>
              <a class="nav--v__link" href="/what-is-a-gem">What is a gem?</a>
              <a class="nav--v__link" href="/make-your-own-gem">Make your own gem</a>
              <a class="nav--v__link" href="/gems-with-extensions">Gems with Extensions</a>
              <a class="nav--v__link" href="/name-your-gem">Name your gem</a>
              <a class="nav--v__link" href="/publishing">Publishing your gem</a>
              <a class="nav--v__link" href="/security">Security Practices</a>
              <a class="nav--v__link" href="/patterns">Patterns</a>
              <a class="nav--v__link" href="/specification-reference">Specification Reference</a>
              <a class="nav--v__link" href="/command-reference">Command Reference</a>
              <a class="nav--v__link" href="http://docs.seattlerb.org/rubygems">RubyGems API</a>
              <a class="nav--v__link" href="/rubygems-org-api">RubyGems.org API</a>
              <a class="nav--v__link" href="/run-your-own-gem-server">Run your own gem server</a>
              <a class="nav--v__link" href="/resources">Resources</a>
              <a class="nav--v__link" href="/contributing">Contributing to RubyGems</a>
              <a class="nav--v__link" href="/faqs">Frequently Asked Questions</a>
              <a class="nav--v__link" href="/plugins">Plugins</a>
              <a class="nav--v__link" href="/credits">Credits</a>
            </div>
          </div>
          <div class="l-colspan--r">
            <div class="t-body">
              <p><em class="t-gray">Creating a gem that includes an extension that is built at install time.</em></p>

<p>Many gems use extensions to wrap libraries that are written in C with a ruby
wrapper.  Examples include <a href="https://rubygems.org/gems/nokogiri">nokogiri</a> which
wraps <a href="http://www.xmlsoft.org">libxml2 and libxslt</a>,
<a href="https://rubygems.org/gems/pg">pg</a> which is an interface to the <a href="http://www.postgresql.org">PostgreSQL
database</a> and the
<a href="https://rubygems.org/gems/mysql">mysql</a> and
<a href="https://rubygems.org/gems/mysql2">mysql2</a> gems which provide an interface to
the <a href="http://www.mysql.com">MySQL database</a>.</p>

<p>Creating a gem that uses an extension involves several steps.  This guide will
focus on what you should put in your gem specification to make this as easy and
maintainable as possible.  The extension in this guide will wrap <code>malloc()</code> and
<code>free()</code> from the C standard library.</p>

<h2 id="gem-layout">Gem layout</h2>

<p>Every gem should start with a Rakefile which contains the tasks needed by
developers to work on the gem.  The files for the extension should go in the
<code>ext/</code> directory in a directory matching the extension’s name.  For this
example we’ll use “my_malloc” for the name.</p>

<p>Some extensions will be partially written in C and partially written in ruby.
If you are going to support multiple languages, such as C and Java extensions,
you should put the C-specific ruby files under the <code>ext/</code> directory as well in a
<code>lib/</code> directory.</p>

<pre><code>Rakefile
ext/my_malloc/extconf.rb               # extension configuration
ext/my_malloc/my_malloc.c              # extension source
lib/my_malloc.rb                       # generic features
</code></pre>

<p>When the extension is built the files in <code>ext/my_malloc/lib/</code> will be installed
into the <code>lib/</code> directory for you.</p>

<h2 id="extconfrb">extconf.rb</h2>

<p>The extconf.rb configures a Makefile that will build your extension based.  The
extconf.rb must check for the necessary functions, macros and shared libraries
your extension depends upon.  The extconf.rb must exit with an error if any of
these are missing.</p>

<p>Here is an extconf.rb that checks for <code>malloc()</code> and <code>free()</code> and creates a
Makefile that will install the built extension at <code>lib/my_malloc/my_malloc.so</code>:</p>

<pre><code>require "mkmf"

abort "missing malloc()" unless have_func "malloc"
abort "missing free()"   unless have_func "free"

create_makefile "my_malloc/my_malloc"
</code></pre>

<p>See the <a href="http://ruby-doc.org/stdlib-2.0/libdoc/mkmf/rdoc/MakeMakefile.html">mkmf documentation</a> and <a href="https://github.com/ruby/ruby/blob/trunk/README.EXT">README.EXT</a> for further
information about creating an extconf.rb and for documentation on these
methods.</p>

<h2 id="c-extension">C Extension</h2>

<p>The C extension that wraps <code>malloc()</code> and <code>free()</code> goes in
<code>ext/my_malloc/my_malloc.c</code>.  Here’s the listing:</p>

<pre><code>#include &lt;ruby.h&gt;

struct my_malloc {
size_t size;
void *ptr;
};

static void
my_malloc_free(void *p) {
struct my_malloc *ptr = p;

if (ptr-&gt;size &gt; 0)
    free(ptr-&gt;ptr);
}

static VALUE
my_malloc_alloc(VALUE klass) {
VALUE obj;
struct my_malloc *ptr;

obj = Data_Make_Struct(klass, struct my_malloc, NULL, my_malloc_free, ptr);

ptr-&gt;size = 0;
ptr-&gt;ptr  = NULL;

return obj;
}

static VALUE
my_malloc_init(VALUE self, VALUE size) {
struct my_malloc *ptr;
size_t requested = NUM2SIZET(size);

if (0 == requested)
    rb_raise(rb_eArgError, "unable to allocate 0 bytes");

Data_Get_Struct(self, struct my_malloc, ptr);

ptr-&gt;ptr = malloc(requested);

if (NULL == ptr-&gt;ptr)
    rb_raise(rb_eNoMemError, "unable to allocate %ld bytes", requested);

ptr-&gt;size = requested;

return self;
}

static VALUE
my_malloc_release(VALUE self) {
struct my_malloc *ptr;

Data_Get_Struct(self, struct my_malloc, ptr);

if (0 == ptr-&gt;size)
    return self;

ptr-&gt;size = 0;
free(ptr-&gt;ptr);

return self;
}

void
Init_my_malloc(void) {
VALUE cMyMalloc;

cMyMalloc = rb_const_get(rb_cObject, rb_intern("MyMalloc"));

rb_define_alloc_func(cMyMalloc, my_malloc_alloc);
rb_define_method(cMyMalloc, "initialize", my_malloc_init, 1);
rb_define_method(cMyMalloc, "free", my_malloc_release, 0);
}
</code></pre>

<p>This extension is simple with just a few parts:</p>

<ul>
  <li><code>struct my_malloc</code> to hold the allocated memory</li>
  <li><code>my_malloc_free()</code> to free the allocated memory after garbage collection</li>
  <li><code>my_malloc_alloc()</code> to create the ruby wrapper object</li>
  <li><code>my_malloc_init()</code> to allocate memory from ruby</li>
  <li><code>my_malloc_release()</code> to free memory from ruby</li>
  <li><code>Init_my_malloc()</code> to register the functions in the <code>MyMalloc</code> class.</li>
</ul>

<p>You can test building the extension as follows:</p>

<pre><code>$ cd ext/my_malloc
$ ruby extconf.rb
checking for malloc()... yes
checking for free()... yes
creating Makefile
$ make
compiling my_malloc.c
linking shared-object my_malloc.bundle
$ cd ../..
$ ruby -Ilib:ext -r my_malloc -e "p MyMalloc.new(5).free"
#&lt;MyMalloc:0x007fed838addb0&gt;
</code></pre>

<p>But this will get tedious after a while.  Let’s automate it!</p>

<h2 id="rake-compiler">rake-compiler</h2>

<p><a href="https://github.com/luislavena/rake-compiler">rake-compiler</a> is a set of rake
tasks for automating extension building.  rake-compiler can be used with C or
Java extensions in the same project (nokogiri uses it this way).</p>

<p>Adding rake-compiler is very simple:</p>

<pre><code>require "rake/extensiontask"

Rake::ExtensionTask.new "my_malloc" do |ext|
  ext.lib_dir = "lib/my_malloc"
end
</code></pre>

<p>Now you can build the extension with <code>rake compile</code> and hook the compile task
into other tasks (such as tests).</p>

<p>Setting <code>lib_dir</code> places the shared library in <code>lib/my_malloc/my_malloc.so</code> (or
<code>.bundle</code> or <code>.dll</code>).  This allows the top-level file for the gem to be a ruby
file.  This allows you to write the parts that are best suited to ruby in ruby.</p>

<p>For example:</p>

<pre><code>class MyMalloc

  VERSION = "1.0"

end

require "my_malloc/my_malloc"
</code></pre>

<p>Setting the <code>lib_dir</code> also allows you to build a gem that contains pre-built
extensions for multiple versions of ruby.  (An extension for Ruby 1.9.3 cannot
be used with an extension for Ruby 2.0.0).  <code>lib/my_malloc.rb</code> can pick the
correct shared library to install.</p>

<h2 id="gem-specification">Gem specification</h2>

<p>The final step to building the gem is adding the extconf.rb to the extensions
list in the gemspec:</p>

<pre><code>Gem::Specification.new "my_malloc", "1.0" do |s|
  # [...]

  s.extensions = %w[ext/my_malloc/extconf.rb]
end
</code></pre>

<p>Now you can build and release the gem!</p>

<h2 id="extension-naming">Extension Naming</h2>

<p>To avoid unintended interactions between gems, it’s a good idea for each gem to
keep all of its files in a single directory.  Here are the recommendations for
a gem with the name <code>&lt;name&gt;</code>:</p>

<ol>
  <li><code>ext/&lt;name&gt;</code> is the directory that contains the source files and
<code>extconf.rb</code></li>
  <li><code>ext/&lt;name&gt;/&lt;name&gt;.c</code> is the main source file (there may be others)</li>
  <li><code>ext/&lt;name&gt;/&lt;name&gt;.c</code> contains a function <code>Init_&lt;name&gt;</code>.  (The name
following <code>Init_</code> function must exactly match the name of the extension for
it to be loadable by require.)</li>
  <li><code>ext/&lt;name&gt;/extconf.rb</code> calls <code>create_makefile('&lt;name&gt;/&lt;name&gt;')</code> only when
the all the pieces needed to compile the extension are present.</li>
  <li>The gemspec sets <code>extensions = ['ext/&lt;name&gt;/extconf.rb']</code> and includes any
of the necessary extension source files in the <code>files</code> list.</li>
  <li><code>lib/&lt;name&gt;.rb</code> contains <code>require '&lt;name&gt;/&lt;name&gt;'</code> which loads the C
extension</li>
</ol>

<h2 id="further-reading">Further Reading</h2>

<ul>
  <li><a href="https://github.com/rubygems/guides/tree/my_malloc">my_malloc</a> contains the
source for this extension with some additional comments.</li>
  <li><a href="https://github.com/ruby/ruby/blob/trunk/README.EXT">README.EXT</a> describes in greater detail how to build extensions
in ruby</li>
  <li><a href="http://ruby-doc.org/stdlib-2.0/libdoc/mkmf/rdoc/MakeMakefile.html">MakeMakefile</a> contains documentation for mkmf.rb, the library
extconf.rb uses to detect ruby and C library features</li>
  <li><a href="https://github.com/luislavena/rake-compiler">rake-compiler</a> integrates building C and Java extensions into
your Rakefile in a smooth manner.</li>
  <li><a href="http://tenderlovemaking.com/2009/12/18/writing-ruby-c-extensions-part-1.html">Writing C extensions part
1</a>
and <a href="http://tenderlovemaking.com/2010/12/11/writing-ruby-c-extensions-part-2.html">part 2</a>)
by Aaron Patterson</li>
  <li>Interfaces to C libraries can be written using ruby and
<a href="http://ruby-doc.org/stdlib-2.0/libdoc/fiddle/rdoc/Fiddle.html">fiddle</a> (part
of the standard library) or <a href="https://github.com/ffi/ffi">ruby-ffi</a></li>
</ul>


            </div>
          </div>
        </div>

        <div class="paginated-nav-links">
          <a class="paginated-nav-link--prev" data-icon="&lt;" href="/make-your-own-gem">
            <span>Previous</span>
          </a>
          <a class="paginated-nav-link--next" data-icon="&gt;" href="/name-your-gem">
            <span>Next</span>
          </a>
        </div>
      </div>
    </main>

    <div class="modal-wrap" id="js-sign-in-modal">
      <form class="modal--sign-in">
        <a class="modal__close" data-icon="x" href="#" id="js-sign-in-close">
          <span class="t-hidden">Close modal</span>
        </a>
        <div class="modal__input-wrap">
          <label class="modal__label t-hidden" for="email">Email or Username</label>
          <input class="modal__input" id="email" name="email" placeholder="Email or Username" type="text">
        </div>
        <div class="modal__input-wrap">
          <label class="modal__label t-hidden" for="password">Password</label>
          <input class="modal__input" id="password" name="password" placeholder="Password" type="password">
        </div>
        <button class="modal__submit" data-icon="&gt;" type="submit">Sign in</button>
      </form>
    </div>

    <div class="modal-wrap" id="js-sign-up-modal">
      <form class="modal--sign-up">
        <a class="modal__close" data-icon="x" href="#" id="js-sign-up-close">
          <span class="t-hidden">Close modal</span>
        </a>
        <div class="modal__input-wrap">
          <label class="modal__label t-hidden" for="email">Email</label>
          <input class="modal__input" id="email" name="email" placeholder="Email" type="email">
        </div>
        <div class="modal__input-wrap">
          <label class="modal__label t-hidden" for="username">Username</label>
          <input class="modal__input" id="username" name="username" placeholder="Username" type="text">
        </div>
        <div class="modal__input-wrap">
          <label class="modal__label t-hidden" for="password">Password</label>
          <input class="modal__input" id="password" name="password" placeholder="Password" type="password">
        </div>
        <button class="modal__submit" data-icon="&gt;" type="submit">Sign up</button>
      </form>
    </div>

    <footer class="footer">
      <div class="l-wrap--footer">
        <div class="l-overflow">
          <div class="nav--v l-col--r--pad">
            <a class="nav--v__link--footer" href="/status">Status</a>
            <a class="nav--v__link--footer" href="/uptime">Uptime</a>
            <a class="nav--v__link--footer" href="https://github.com/rubygems/rubygems.org" target='_blank'>Code</a>
            <a class="nav--v__link--footer" href="https://groups.google.com/forum/#!forum/rubygems-org" target='_blank'>Discuss</a>
            <a class="nav--v__link--footer" href="/stats">Stats</a>
            <a class="nav--v__link--footer" href="/blogs">Blog</a>
            <a class="nav--v__link--footer" href="/about">About</a>
            <a class="nav--v__link--footer" href="/help">Help</a>
          </div>
          <div class="l-colspan--l colspan--l--has-border">
            <p class="footer__about">RubyGems.org is the Ruby community&rsquo;s gem hosting service. Instantly publish your gems and install them. Use the API to interact and find out more information about available gems. Become a contributor and enhance the site with your own changes.</p>
          </div>
        </div>
      </div>
      <div class="footer__sponsors-wrap">
        <div class="footer__sponsors">
          <a class="footer__sponsor" href="http://rubycentral.org/" target="_blank">
            Supported by
            <img alt="Ruby Central" class="footer__sponsor__logo" src="/images/logos/ruby-central.png">
          </a>
          <a class="footer__sponsor" href="https://www.bluebox.net/" target="_blank">
            Hosted by
            <img alt="Blue Box" class="footer__sponsor__logo" src="/images/logos/bluebox.png">
          </a>
          <a class="footer__sponsor" href="http://www.dockyard.com/" target="_blank">
            Designed by
            <img alt="DockYard" class="footer__sponsor__logo" src="/images/logos/dockyard.png">
          </a>
          <a class="footer__sponsor" href="https://dnsimple.com/" target="_blank">
            Resolved with
            <img alt="DNSimple" class="footer__sponsor__logo" src="/images/logos/dnsimple.png">
          </a>
          <a class="footer__sponsor" href="http://newrelic.com/" target="_blank">
            Optimized by
            <img alt="New Relic" class="footer__sponsor__logo" src="/images/logos/new-relic.png">
          </a>
          <a class="footer__sponsor" href="http://get.gaug.es/" target="_blank">
            Tracking by
            <img alt="Gauges" class="footer__sponsor__logo" src="/images/logos/gauges.png">
          </a>
          <a class="footer__sponsor" href="https://www.runscope.com/" target="_blank">
            Monitored by
            <img alt="Runscope" class="footer__sponsor__logo" src="/images/logos/runscope.png">
          </a>
        </div>
      </div>
    </footer>

    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-10315684-2']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </body>
</html>
